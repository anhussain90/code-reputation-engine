name: Collect Analysis Feedback

on:
  workflow_dispatch:   # Triggered externally

jobs:
  collect:
    runs-on: ubuntu-latest

    permissions:
      actions: read
      checks: read
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install requests

      # Find latest Static Analysis workflow run
      - name: Find latest analysis run id
        id: findrun
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: python scripts/find_latest_analysis_run.py

      # Collect annotations
      - name: Collect annotations
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ steps.findrun.outputs.run_id }}
        run: python scripts/collect_annotations.py

      # Commit report
      - name: Commit report
        run: |
          git config user.name "analysis-bot"
          git config user.email "analysis-bot@users.noreply.github.com"
          git add reports/analysis_report.json
          git commit -m "Update static analysis report"
          git push
